(()=>{var e={};e.id=7332,e.ids=[7332],e.modules={325:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>y,routeModule:()=>c,serverHooks:()=>p,workAsyncStorage:()=>f,workUnitAsyncStorage:()=>_});var i={};t.r(i),t.d(i,{GET:()=>u});var a=t(6559),s=t(8088),o=t(7719),n=t(2190);let l=new(t(6330)).PrismaClient,d=(e,r)=>2===e.sirket_id?r:(e.mt||0)*r;async function u(e){try{let{searchParams:r}=new URL(e.url),t=r.get("sofor_id"),i=r.get("ay"),a=r.get("donem");if(!t){let e=await l.araclar.findMany({where:{sofor_adi:{not:""}},distinct:["sofor_adi"],select:{sofor_adi:!0,plaka:!0}}),r=await l.seferler.findMany({include:{sirket:!0,arac:!0}}),t=r.reduce((e,r)=>{let t=d(r,r.sofore_odenen_ucret);return e+t},0),i=await l.aracOdemeKayitlari.findMany({include:{arac:!0}}),a=i.reduce((e,r)=>e+r.odeme_tutari,0),s=t-a,o=[];for(let t of e){if(!t.sofor_adi)continue;let e=r.filter(e=>e.arac?.sofor_adi===t.sofor_adi),a=e.reduce((e,r)=>{let t=d(r,r.sofore_odenen_ucret);return e+t},0),s=i.filter(e=>e.arac?.sofor_adi===t.sofor_adi).reduce((e,r)=>e+r.odeme_tutari,0),n=[...new Set(e.map(e=>e.sirket?.sirket_adi))];o.push({sofor_adi:t.sofor_adi,plaka:t.plaka,gelir:a,gider:s,netKazanc:a-s,seferSayisi:e.length,calistigiSirketler:n.join(", "),sirketSayisi:n.length})}let u=r.reduce((e,r)=>{let t=r.ay||0;e[t]||(e[t]={ay:t,gelir:0,gider:0,seferSayisi:0});let a=d(r,r.sofore_odenen_ucret);e[t].gelir+=a;let s=i.filter(e=>new Date(e.odeme_tarihi).getMonth()+1===t).reduce((e,r)=>e+r.odeme_tutari,0);return e[t].gider+=s,e[t].seferSayisi+=1,e},{}),c=Object.values(u).sort((e,r)=>e.ay-r.ay),f={genel:!0,gelirGider:{toplamGelir:t,toplamGider:a,netKazanc:s,karMarji:t>0?(s/t*100).toFixed(2):"0"},seferler:{toplamSeferSayisi:r.length,aylikDagitim:c},soforler:{toplamSoforSayisi:e.length,soforBazindaVeriler:o.sort((e,r)=>r.gelir-e.gelir)}};return n.NextResponse.json(f)}let s=await l.araclar.findFirst({where:{sofor_adi:t}});if(!s)return n.NextResponse.json({error:"Ş\xf6f\xf6r bulunamadı"},{status:404});let o={arac:{sofor_adi:t}};i&&(o.ay=parseInt(i)),a&&(o.donem=parseInt(a));let u=await l.seferler.findMany({where:o,include:{arac:!0,sirket:!0}}),c=u.reduce((e,r)=>{let t=d(r,r.sofore_odenen_ucret);return e+t},0),f=await l.aracOdemeKayitlari.findMany({where:{arac:{sofor_adi:t}},include:{arac:!0}}),_=f;i&&(_=f.filter(e=>new Date(e.odeme_tarihi).getMonth()+1===parseInt(i))),a&&(_=_.filter(e=>new Date(e.odeme_tarihi).getFullYear()===parseInt(a)));let p=_.reduce((e,r)=>e+r.odeme_tutari,0),y=c-p,m={};u.forEach(e=>{let r=e.sirket?.sirket_adi||"Bilinmeyen Şirket";m[r]||(m[r]={sirket_adi:r,gelir:0,gider:0,seferSayisi:0});let t=d(e,e.sofore_odenen_ucret);m[r].gelir+=t,m[r].seferSayisi+=1});let g=u.length;Object.keys(m).forEach(e=>{let r=m[e].seferSayisi/g;m[e].gider=p*r});let k=Object.values(m).map(e=>({...e,netKazanc:e.gelir-e.gider})),h=u.reduce((e,r)=>{let t=r.ay||0;e[t]||(e[t]={ay:t,gelir:0,gider:0,seferSayisi:0});let i=d(r,r.sofore_odenen_ucret);return e[t].gelir+=i,e[t].seferSayisi+=1,e},{});Object.keys(h).forEach(e=>{let r=parseInt(e),t=f.filter(e=>new Date(e.odeme_tarihi).getMonth()+1===r).reduce((e,r)=>e+r.odeme_tutari,0);h[e].gider=t});let w=Object.values(h).sort((e,r)=>e.ay-r.ay),x=await Promise.all(u.map(async e=>{let r=null;try{let t=await l.sirketFiyatListesi.findFirst({where:{sirket_id:e.sirket_id,ucret:e.sirketten_alinan_ucret,arac_tipi:e.arac_tipi}});t||(t=await l.sirketFiyatListesi.findFirst({where:{sirket_id:e.sirket_id,arac_tipi:e.arac_tipi,ucret:{gte:e.sirketten_alinan_ucret-.01,lte:e.sirketten_alinan_ucret+.01}}})),r=t?.tahliye_yeri||null}catch(e){console.log("Fiyat listesi sorgusu hatası:",e)}return{sefer_id:e.sefer_id,sira_no:e.sira_no,mt:e.mt,birimFiyat:e.sofore_odenen_ucret,toplamFiyat:d(e,e.sofore_odenen_ucret),tahliye_yeri:e.tahliye_yeri,arac_tipi:e.arac_tipi,sirket_adi:e.sirket?.sirket_adi||"Bilinmeyen",fiyatListesiTahliyeYeri:r}})),v={genel:!1,sofor:{sofor_adi:s.sofor_adi,plaka:s.plaka,vergi_numarasi:s.vergi_numarasi},gelirGider:{toplamGelir:c,toplamGider:p,netKazanc:y,karMarji:c>0?(y/c*100).toFixed(2):"0"},seferler:{toplamSeferSayisi:u.length,aylikDagitim:w,seferDetaylari:x},sirketler:{sirketDagitimi:k},filtrelemeBilgileri:{ay:i?parseInt(i):null,donem:a?parseInt(a):null},aracMasraflari:{toplamMasraf:p,masrafDetaylari:_.map(e=>({odeme_id:e.odeme_id,odeme_tutari:e.odeme_tutari,odeme_tarihi:e.odeme_tarihi,aciklama:e.aciklama,plaka:e.arac?.plaka}))}};return n.NextResponse.json(v)}catch(e){return console.error("Ş\xf6f\xf6r bilan\xe7o verisi alınırken hata:",e),n.NextResponse.json({error:"Bilan\xe7o verisi alınırken bir hata oluştu"},{status:500})}finally{await l.$disconnect()}}let c=new a.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/sofor-bilanco/route",pathname:"/api/sofor-bilanco",filename:"route",bundlePath:"app/api/sofor-bilanco/route"},resolvedPagePath:"/Users/yusufmertyavuz/Desktop/nakliyeemm/src/app/api/sofor-bilanco/route.ts",nextConfigOutput:"",userland:i}),{workAsyncStorage:f,workUnitAsyncStorage:_,serverHooks:p}=c;function y(){return(0,o.patchFetch)({workAsyncStorage:f,workUnitAsyncStorage:_})}},846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6330:e=>{"use strict";e.exports=require("@prisma/client")},6487:()=>{},8335:()=>{},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),i=r.X(0,[4447,580],()=>t(325));module.exports=i})();