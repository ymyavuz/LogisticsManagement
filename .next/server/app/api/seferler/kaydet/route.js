(()=>{var e={};e.id=6869,e.ids=[6869],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6330:e=>{"use strict";e.exports=require("@prisma/client")},6487:()=>{},8335:()=>{},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9854:(e,r,l)=>{"use strict";l.r(r),l.d(r,{patchFetch:()=>k,routeModule:()=>m,serverHooks:()=>f,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>g});var i={};l.r(i),l.d(i,{POST:()=>u});var t=l(6559),a=l(8088),o=l(7719),n=l(2190);let s=new(l(6330)).PrismaClient;async function u(e){try{let{ay:r,donem:l,seferler:i}=await e.json();if(console.log("Gelen veri:",{ay:r,donem:l,seferSayisi:Object.keys(i).length}),console.log("EXCEL HAM VERİ KONTROL:"),i&&"object"==typeof i){for(let[e,r]of Object.entries(i))if(Array.isArray(r)&&r.length>0){let l=r[0];console.log(`ŞİRKET ${e} \xd6RNEK SEFER:`,JSON.stringify(l,null,2)),l.tumVeriler&&console.log("T\xdcM VERİLER:",JSON.stringify(l.tumVeriler,null,2));break}}if(!r||!l)return n.NextResponse.json({error:"Ay ve d\xf6nem bilgileri gereklidir"},{status:400});if(!i||0===Object.keys(i).length)return n.NextResponse.json({error:"Kaydedilecek sefer verisi bulunamadı"},{status:400});let t=0;for(let[e,a]of Object.entries(i)){let i=parseInt(e,10);if(console.log(`Şirket ${i} i\xe7in sefer sayısı:`,Array.isArray(a)?a.length:"Dizi değil"),!Array.isArray(a)){console.error(`Şirket ID ${i} i\xe7in ge\xe7ersiz veri formatı:`,a);continue}for(let e of a)try{let a=parseInt(e.seferNo,10)||0;console.log(`Sefer işleniyor: Şirket ${i}, Sefer ${a}`,e.tumVeriler?"Veri mevcut":"Veri yok"),e.tumVeriler&&console.log("Sefer verileri:",Object.keys(e.tumVeriler)),console.log("Excel ham verileri:"),e.tumVeriler&&(console.log("İrsaliye Numarası:",e.tumVeriler["İrsaliye Numarası"]||"null"),console.log("Tahliye Edilen Firma:",e.tumVeriler["Tahliye Edilen Firma"]||"null"),Object.keys(e.tumVeriler).forEach(r=>{r.toLowerCase().includes("tahliye")&&r.toLowerCase().includes("yer")&&console.log(`${r}:`,e.tumVeriler[r]||"null")}),console.log("T\xfcm Excel alanları:",Object.keys(e.tumVeriler).map(r=>`${r}: ${e.tumVeriler[r]}`)));let o=c(e,"İrsaliye Numarası")||null,n=null;try{let r=c(e,"İrsaliye Tarihi");if(r){let e=function(e){if(!e)return null;try{let r=e.trim(),l=r.match(/^(\d{1,2})\s+(\d{1,2})\s+(\d{4})$/);if(l){let e=parseInt(l[1],10),r=parseInt(l[2],10)-1,i=parseInt(l[3],10);if(isNaN(e)||isNaN(r)||isNaN(i)||e<1||e>31||r<0||r>11)return console.log(`Ge\xe7ersiz tarih değerleri: G\xfcn=${e}, Ay=${r+1}, Yıl=${i}`),null;let t=new Date(i,r,e);if(isNaN(t.getTime()))return console.log(`Oluşturulan tarih ge\xe7erli değil: ${t}`),null;return console.log(`Başarıyla ayrıştırılan GG AA YYYY formatı: ${t.toISOString()}`),t}let i=r.split(/[\/\.]/);if(i.length>=3){let e=parseInt(i[0],10),r=parseInt(i[1],10)-1,l=parseInt(i[2],10);if(l<100&&(l+=2e3),isNaN(e)||isNaN(r)||isNaN(l)||e<1||e>31||r<0||r>11)return null;let t=new Date(l,r,e);if(isNaN(t.getTime()))return null;return t}let t=new Date(r);if(!isNaN(t.getTime()))return t;return null}catch(e){return console.error("Tarih ayrıştırma hatası:",e),null}}(r);e&&!isNaN(e.getTime())&&(n=e)}}catch(e){console.log("İrsaliye tarihi ayrıştırılamadı, null olarak kaydedilecek")}let u=null;try{let r=c(e,"Kalkış Saati");r&&""!==r.trim()&&(u=d(r))&&isNaN(u.getTime())&&(u=null)}catch(e){console.log("Kalkış saati ayrıştırılamadı, null olarak kaydedilecek")}let m=null;try{let r=c(e,"Varış Saati");r&&""!==r.trim()&&(m=d(r))&&isNaN(m.getTime())&&(m=null)}catch(e){console.log("Varış saati ayrıştırılamadı, null olarak kaydedilecek")}let y=c(e,"Şof\xf6r");console.log(`Şof\xf6r adı: ${y||"Belirtilmemiş"}`);let g=null;if(y&&""!==y.trim())try{let e=await s.araclar.findFirst({where:{sofor_adi:{contains:y.trim(),mode:"insensitive"}}});e?(g=e.arac_id,console.log(`Şof\xf6r "${y}" i\xe7in ara\xe7 bulundu: ID ${g}`)):(console.log(`Şof\xf6r "${y}" i\xe7in ara\xe7 bulunamadı, null değer kullanılacak`),g=null)}catch(e){console.error("Ara\xe7 sorgusu sırasında hata:",e),g=null}else g=null,console.log(`Şof\xf6r belirtilmemiş, null değer kullanılacak`);let f=c(e,"\xc7ıkış Yeri")||"",k=c(e,"Tahliye Edilen Firma")||"",p=c(e,"Tahliye Yeri/Fırın")||c(e,"Tahliye Yeri")||c(e,"Tahliye Yeri/Tesisi")||"",h=c(e,"Tonaj/Kg")||c(e,"Tonaj")||"0",x=null;try{let r=c(e,"MT");r&&(x=parseFloat(r.replace(/,/g,"."))||null)}catch(e){console.log("MT değeri ayrıştırılamadı, null olarak kaydedilecek")}let $=c(e,"A\xe7ıklama")||null,T=c(e,"Ara\xe7 Tipi Tlr/K.Ayak")||c(e,"Ara\xe7 Tipi")||"";null!==x?(T=x<23?"Kırkayak":"Tır",console.log(`MT değerine (${x}) g\xf6re ara\xe7 tipi belirlendi: ${T}`)):console.log("MT değeri olmadığı i\xe7in Excel'deki ara\xe7 tipi kullanılacak:",T);let N=0;try{N=function(e){if(!e.tumVeriler)return 0;let r=null;if(e.tumVeriler["Ton/Fiyat"]&&console.log("Ton/Fiyat değeri bulundu:",r=e.tumVeriler["Ton/Fiyat"]),null!=r&&""!==r){let e=parseFloat(String(r).replace(/[^\d.,]/g,"").replace(",","."));if(!isNaN(e))return console.log("Ton/Fiyat parse edildi:",e),e}return console.log("Ton/Fiyat s\xfctunu bulunamadı veya boş"),0}(e)||0}catch(e){console.log("Taşıma fiyatı ayrıştırılamadı, 0 olarak kaydedilecek")}let V=0;try{let r=c(e,"Ş\xf6f\xf6r \xdccreti")||"0";V=parseFloat(r.toString().replace(/[^\d.,]/g,"").replace(",","."))||0,console.log("Ş\xf6f\xf6r \xfccreti:",r,"-> Parse edilen:",V)}catch(e){console.log("Ş\xf6f\xf6r \xfccreti ayrıştırılamadı, 0 olarak kaydedilecek")}let S=null;try{let r=c(e,"Ş\xf6f\xf6r Fatura \xdccreti");r&&(S=parseFloat(r.toString().replace(/[^\d.,]/g,"").replace(",","."))||null,console.log("Ş\xf6f\xf6r fatura \xfccreti:",r,"-> Parse edilen:",S))}catch(e){console.log("Ş\xf6f\xf6r fatura \xfccreti ayrıştırılamadı, null olarak kaydedilecek")}if(console.log("İşlenen değerler:",{cikisYeri:f,tahliyeYeri:p,tonajKg:h,aracTipi:T,tasimaFiyati:N,irsaliyeTarihi:n?"Ge\xe7erli tarih":"null",kalkisSaati:u?"Ge\xe7erli saat":"null",varisSaati:m?"Ge\xe7erli saat":"null",aracId:g}),a<=0){console.warn(`Ge\xe7ersiz sefer no, atlanıyor: Şirket ${i}, Sefer ${a}`);continue}let v={sira_no:a,irsaliye_numarasi:o,irsaliye_tarihi:n,kalkis_saati:u,varis_saati:m,cikis_yeri:f||"Belirtilmemiş",tahliye_edilen_firma:k||"Belirtilmemiş",tahliye_yeri:p||"Belirtilmemiş",tonaj_kg:h,arac_tipi:T||"Belirtilmemiş",mt:x,aciklama:$,sirketten_alinan_ucret:N||0,sofore_odenen_ucret:V||0,sirket_id:i,arac_id:g,ay:r,donem:l,sofor_fatura_ucreti:S};console.log("Kaydedilecek veri:"),console.log(`- Sıra No: ${a}`),console.log(`- İrsaliye Numarası: ${o||"null"}`),console.log(`- İrsaliye Tarihi: ${n?n.toLocaleDateString():"null"}`),console.log(`- Kalkış Saati: ${u?u.toLocaleTimeString():"null"}`),console.log(`- Varış Saati: ${m?m.toLocaleTimeString():"null"}`),console.log(`- \xc7ıkış Yeri: ${f||"Belirtilmemiş"}`),console.log(`- Tahliye Edilen Firma: ${k||"Belirtilmemiş"}`),console.log(`- Tahliye Yeri: ${p||"Belirtilmemiş"}`),console.log(`- Tonaj (kg): ${h}`),console.log(`- Ara\xe7 Tipi: ${T||"Belirtilmemiş"}`),console.log(`- MT: ${x||"null"}`),console.log(`- Şof\xf6r: ${y||"null"}`),console.log(`- Ara\xe7 ID: ${null!==g?g:"null"}`),console.log(`- Ay: ${r}`),console.log(`- D\xf6nem: ${l}`);let b=await s.seferler.create({data:v});console.log("Sefer başarıyla kaydedildi:",b.sefer_id),t++}catch(e){console.error(`Sefer kaydederken hata: Şirket ID ${i}`,e)}}return n.NextResponse.json({success:!0,kaydedilenSeferSayisi:t,message:`${t} sefer başarıyla kaydedildi`})}catch(e){return console.error("API hatası:",e),n.NextResponse.json({error:"Veriler işlenirken bir hata oluştu: "+e.message},{status:500})}}function c(e,r){try{if(console.log(`${r} değeri i\xe7in Excel verisi arama:`,e.tumVeriler?"tumVeriler mevcut":"tumVeriler yok"),!e.tumVeriler&&void 0!==e[r]&&null!==e[r])return console.log(`${r} değeri direkt objede bulundu:`,e[r],typeof e[r]),String(e[r]);if(e?.tumVeriler){if(void 0!==e.tumVeriler[r]&&null!==e.tumVeriler[r])return console.log(`${r} değeri EXCEL'DE TAM OLARAK BULUNDU:`,e.tumVeriler[r],typeof e.tumVeriler[r]),String(e.tumVeriler[r]);console.log(`${r} i\xe7in mevcut Excel alanları:`,Object.keys(e.tumVeriler));let l=Object.keys(e.tumVeriler).filter(e=>e.toLowerCase().includes(r.toLowerCase()));if(l.length>0&&(console.log(`${r} i\xe7in kısmi eşleşen anahtarlar:`,l),void 0!==e.tumVeriler[l[0]]&&null!==e.tumVeriler[l[0]]))return console.log(`${r} i\xe7in eşleşen anahtar ${l[0]} bulundu:`,e.tumVeriler[l[0]],typeof e.tumVeriler[l[0]]),String(e.tumVeriler[l[0]])}return console.log(`${r} i\xe7in hi\xe7bir değer bulunamadı`),null}catch(e){return console.error(`${r} değeri alınırken hata:`,e),null}}function d(e){if(!e)return null;try{let r=e.trim().split(/[:\.]/);if(r.length>=2){let e=parseInt(r[0],10),l=parseInt(r[1],10);if(isNaN(e)||isNaN(l)||e<0||e>23||l<0||l>59)return null;let i=new Date;return i.setHours(e,l,0,0),i}return null}catch(e){return console.error("Saat ayrıştırma hatası:",e),null}}let m=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/seferler/kaydet/route",pathname:"/api/seferler/kaydet",filename:"route",bundlePath:"app/api/seferler/kaydet/route"},resolvedPagePath:"/Users/yusufmertyavuz/Desktop/nakliyeemm/src/app/api/seferler/kaydet/route.ts",nextConfigOutput:"",userland:i}),{workAsyncStorage:y,workUnitAsyncStorage:g,serverHooks:f}=m;function k(){return(0,o.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:g})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var l=e=>r(r.s=e),i=r.X(0,[4447,580],()=>l(9854));module.exports=i})();